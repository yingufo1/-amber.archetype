package cn.com.amber.controller;import cn.com.amber.dto.BaseResponse;import cn.com.amber.dto.req.AccountReq;import cn.com.amber.dto.response.AccountDTO;import cn.com.amber.entity.Account;import cn.com.amber.mapper.AccountMapper;import cn.com.amber.remote.AccountFacade;import com.alibaba.fastjson2.JSONObject;import org.redisson.api.RBucket;import org.redisson.api.RedissonClient;import org.springframework.beans.factory.annotation.Value;import org.springframework.util.StringUtils;import org.springframework.web.bind.annotation.PathVariable;import org.springframework.web.bind.annotation.RequestBody;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;import javax.annotation.Resource;import java.util.UUID;import java.util.concurrent.TimeUnit;/** * TODO:class description * * @author yangying * @version 1.0 * @since 2022/9/3 **/@RestController@RequestMapping(path = "/user")public class MyFristController {    @Resource    private AccountMapper accountMapper;    @Resource    private AccountFacade accountFacade;    @Resource    private RedissonClient redissonClient;    @Value("${accountUrl}")    private String accountUrl;    @RequestMapping(path = "/getUser/{userId}")    public String getUer(@PathVariable String userId) {        if (userId.equals("111")) {            return "john";        }        return "has not found";    }    /**     * 测试从Feign与Eureka的集成，从Eureka的服务列表中请求远程服务     *     * @param accountNo     * @return     */    @RequestMapping(path = "/getAccount/{accountNo}")    public String getAccount(@PathVariable String accountNo) {        if (StringUtils.isEmpty(accountNo)) {            return "get nothing";        }        Account account = accountMapper.selectByAccountNo(accountNo);        return JSONObject.toJSONString(account);    }    @RequestMapping(path = "/getRemoteAccount/{accountNo}")    public String getRemoteAccount(@PathVariable String accountNo) {        return accountFacade.queryAccount(accountNo);    }    /**     * 测试从apollo获取配置     *     * @return     */    @RequestMapping(path = "/getAccountUrl")    public String getRemoteAccount() {        return accountUrl;    }    @RequestMapping(path = "/cacheAccount")    public BaseResponse<AccountDTO> cacheAccount(@RequestBody AccountReq accountReq) {        BaseResponse<AccountDTO> accountResponse;        if (StringUtils.isEmpty(accountReq.getAccountNo())) {            accountResponse = new BaseResponse("E0001", "accountNo为空", accountReq.getRequestId());            return accountResponse;        }        String accountNo = accountReq.getAccountNo();        RBucket<Account> bucket = redissonClient.getBucket(accountNo);        Account account = null;        if(!bucket.isExists()){            account = accountMapper.selectByAccountNo(accountNo);            if(account == null){                accountResponse = new BaseResponse("E0002", "未查询到账户信息,accountNo:"+accountNo, accountReq.getRequestId());                return accountResponse;            }            bucket.set(account,10000, TimeUnit.MILLISECONDS);            account = bucket.get();        }        accountResponse = new BaseResponse("0000", "查询成功,accountNo:"+accountNo, accountReq.getRequestId());        AccountDTO accountDTO =                AccountDTO.builder().accountNo(account.getAccountNo())                        .balance(account.getBalance())                        .balanceDirection(account.getDirection())                        .name(account.getAccountName()).build();        accountResponse.setR(accountDTO);        return accountResponse;    }    @RequestMapping(path = "/cacheAccount/{accountNo}")    public BaseResponse<AccountDTO> cacheAccount(@PathVariable String accountNo) {        BaseResponse<AccountDTO> accountResponse;        RBucket<Account> bucket = redissonClient.getBucket(accountNo);        Account account = null;        if(!bucket.isExists()){            account = accountMapper.selectByAccountNo(accountNo);            if(account == null){                accountResponse = new BaseResponse("E0002", "未查询到账户信息,accountNo:"+accountNo, UUID.randomUUID().toString());                return accountResponse;            }            bucket.set(account,20000, TimeUnit.MILLISECONDS);        }        account = bucket.get();        accountResponse = new BaseResponse("0000", "查询成功,accountNo:"+accountNo, UUID.randomUUID().toString());        AccountDTO accountDTO =                AccountDTO.builder().accountNo(account.getAccountNo())                        .balance(account.getBalance())                        .balanceDirection(account.getDirection())                        .name(account.getAccountName()).build();        accountResponse.setR(accountDTO);        return accountResponse;    }}