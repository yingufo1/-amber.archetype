package cn.com.amber.events;import com.google.gson.Gson;import lombok.extern.slf4j.Slf4j;import org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;import org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;import org.apache.rocketmq.client.exception.MQClientException;import org.apache.rocketmq.common.message.MessageExt;import org.springframework.beans.factory.annotation.Value;import org.springframework.stereotype.Component;import javax.annotation.PostConstruct;import java.util.ArrayList;import java.util.List;/** * Consumer * * @author yangying * @version 1.0 * @since 2022/9/18 **/@Slf4j@Componentpublic abstract class AbstractConsumer {    @Value("${rocketmq.namesrvAddress}")    private String nameSrvAddress;    @Value(("${rocketmq.topic"))    private String topic;    @Value(("${rocketmq.consumer.group"))    private String consumerGroup;    private DefaultMQPushConsumer consumer ;    public AbstractConsumer(String nameSrvAddress, String topic, String consumerGroup) {        this.nameSrvAddress = nameSrvAddress;        this.topic = topic;        this.consumerGroup = consumerGroup;    }    @PostConstruct    public void init(){        consumer = new DefaultMQPushConsumer(consumerGroup);        consumer.setConsumerGroup(consumerGroup);        consumer.setNamesrvAddr(nameSrvAddress);        try {            consumer.subscribe(topic,"*");        } catch (MQClientException e) {            throw new RuntimeException(e);        }        consumer.registerMessageListener(new MessageListenerConcurrently() {            @Override            public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> msgs, ConsumeConcurrentlyContext context) {                log.info("receive message num:{}",msgs.size());                List<Event> events = new ArrayList<>();                for(MessageExt msg :msgs){                    log.info("receive message id:{},body:{}",msg.getMsgId(),msg.getBody());                    Event event = new Gson().fromJson(new String(msg.getBody()),Event.class);                    events.add(event);                }                return consume(events);            }        });        try {            consumer.start();        } catch (MQClientException e) {            throw new RuntimeException(e);        }    }    public abstract ConsumeConcurrentlyStatus  consume(List<Event> msgs);    public void shutdown(){        consumer.shutdown();    }}